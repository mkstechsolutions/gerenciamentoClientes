<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Gerenciamento Clientes</title>
    <style>
        .roxo {
            background: linear-gradient(90deg, #7e22ce, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .pay-tittle {
            background: linear-gradient(90deg, #7e22ce, #af5aff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            padding-right: 5px;
        }

        .flex flex-col {
            display: flex;
            flex-direction: column;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* Efeito de anima√ß√£o no fundo do login */
        .bg-animate {
            background: radial-gradient(circle at top left, #1e293b 0%, #020617 100%);
        }

        .atrasado-row {
            animation: pulse-red 2.5s infinite;
        }

        @keyframes pulse-red {

            0%,
            100% {
                background-color: rgba(15, 23, 42, 1);
            }

            50% {
                background-color: rgba(220, 38, 38, 0.08);
            }
        }

        .loading-state {
            opacity: 0.4;
            pointer-events: none;
            filter: grayscale(1);
            transition: all 0.3s;
        }

        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 1000;
        }

        #toast.show {
            transform: translateX(-50%) translateY(0);
        }

        @media print {
            body>*:not(#modalComprovante) {
                display: none !important;
            }

            #modalComprovante {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: block !important;
                background: white !important;
                color: black !important;
            }

            .no-print {
                display: none !important;
            }
        }
    </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen pb-10">

    <div id="toast"
        class="bg-emerald-600 text-white px-8 py-4 rounded-2xl font-black uppercase text-xs shadow-2xl flex items-center gap-3 border border-emerald-400/30">
        <span class="text-xl">‚úÖ</span>
        <span id="toast-msg">Sucesso!</span>
    </div>

    <div id="login-screen" class="fixed inset-0 bg-animate flex items-center justify-center z-[200] p-6">
        <div class="w-full max-w-[400px] relative">
            <div class="absolute -top-20 -left-20 w-40 h-40 bg-blue-600/20 rounded-full blur-[80px]"></div>
            <div class="absolute -bottom-20 -right-20 w-40 h-40 bg-indigo-600/20 rounded-full blur-[80px]"></div>

            <div
                class="bg-slate-900/50 backdrop-blur-xl border border-slate-800 p-8 rounded-[2.5rem] shadow-2xl relative overflow-hidden">
                <div class="text-center mb-8">
                    <div
                        class="inline-flex items-center justify-center w-16 h-16 bg-blue-600/10 border border-blue-500/20 rounded-2xl mb-6 shadow-inner">
                        <span class="text-3xl">üîí</span>
                    </div>
                    <h1 class="text-blue-500 font-black italic uppercase tracking-tighter text-3xl leading-none">
                        SYSTEM<span class="pay-tittle">PAY</span></h1>
                    <p class="text-slate-500 text-[10px] font-bold uppercase tracking-[0.3em] mt-2">Gest√£o de Clientes e
                        Financeira </p>
                </div>

                <div class="space-y-5">
                    <div class="relative">
                        <input type="password" id="input-senha" placeholder="Senha"
                            class="w-full p-5 bg-slate-950/50 border border-slate-800 rounded-2xl outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-center text-xl text-white font-bold transition-all placeholder:opacity-20">
                    </div>

                    <button id="btnLogin" onclick="fazerLogin()"
                        class="w-full bg-blue-600 p-5 rounded-2xl font-black uppercase tracking-widest text-white shadow-lg shadow-blue-900/40 hover:bg-blue-500 hover:-translate-y-0.5 active:scale-95 transition-all flex items-center justify-center gap-3">
                        <span>ENTRAR</span>
                        <span class="text-lg">‚Üí</span>
                    </button>

                    <p class="text-center text-slate-600 text-[9px] font-bold uppercase tracking-widest pt-4">MKS Tech
                        Solutions ¬© 2026</p>
                </div>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden p-4 md:p-6 lg:p-8 max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-xl md:text-2xl font-black text-white tracking-tighter uppercase italic roxo">
                    Gerenciamento</h1>
                <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest ">MKS Tech Solutions</p>
            </div>
            <button id="btnSair" onclick="fazerLogout()"
                class="bg-red-500/10 hover:bg-red-500/20 text-red-500 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest border border-red-500/20 transition-all">Sair
                üîí</button>
        </header>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
            <div class="bg-slate-900 border border-slate-800 p-6 rounded-3xl border-b-4 border-b-blue-500 shadow-xl">
                <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Bruto Total</p>
                <h2 id="st-bruto" class="text-2xl md:text-3xl font-black text-blue-400">R$ 0,00</h2>
            </div>
            <div class="bg-slate-900 border border-slate-800 p-6 rounded-3xl border-b-4 border-b-emerald-500 shadow-xl">
                <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Recebido</p>
                <h2 id="st-rec" class="text-2xl md:text-3xl font-black text-emerald-400">R$ 0,00</h2>
            </div>
            <div class="bg-slate-900 border border-slate-800 p-6 rounded-3xl border-b-4 border-b-red-500 shadow-xl">
                <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Pendente</p>
                <h2 id="st-rest" class="text-2xl md:text-3xl font-black text-red-400">R$ 0,00</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-8">
            <div class="lg:col-span-4 bg-slate-900 border border-slate-800 p-6 rounded-3xl flex flex-col shadow-lg">
                <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-6">Faturamento Mensal</p>
                <div class="w-full relative h-[250px]">
                    <canvas id="graficoMensal"></canvas>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-4">
                <div class="flex flex-col sm:flex-row gap-3">
                    <div class="relative flex-1">
                        <input type="text" id="busca" onkeyup="filtrarTudo()" placeholder="Buscar cliente..."
                            class="bg-slate-900 border border-slate-800 p-4 pl-12 rounded-2xl w-full outline-none focus:border-blue-500 text-sm font-medium">
                        <span class="absolute left-4 top-4.5 opacity-30">üîç</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="carregar()" id="btnReload"
                            class="bg-slate-900 border border-slate-800 px-5 rounded-2xl hover:bg-slate-800 active:scale-90 transition-all">üîÑ</button>
                        <button id="btnHist" onclick="switchTab('logs')"
                            class="bg-slate-800/50 px-5 py-4 rounded-2xl font-bold text-[10px] uppercase tracking-widest">üìú
                            Hist√≥rico</button>
                        <button id="btnNovo" onclick="abrirNovo()"
                            class="bg-blue-600 px-6 py-4 rounded-2xl font-bold text-[10px] uppercase shadow-lg shadow-blue-900/40">Novo
                            <br> Cliente üöÄ</button>
                    </div>
                </div>

                <div id="tab-dash" class="bg-slate-900 border border-slate-800 rounded-3xl overflow-hidden shadow-2xl">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left min-w-[600px]">
                            <thead class="bg-slate-800/50 text-slate-400 text-[10px] uppercase font-bold">
                                <tr>
                                    <th class="p-5">Cliente / Registro</th>
                                    <th class="p-5">Item</th>
                                    <th class="p-5">Saldo</th>
                                    <th class="p-5">Vencimento</th>
                                    <th class="p-5 text-center">A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="lista" class="divide-y divide-slate-800/50"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-logs" class="hidden space-y-4 max-w-4xl mx-auto">
                    <button onclick="switchTab('dash')" class="text-blue-500 mb-2 font-bold text-xs flex items-center">
                        <span class="mr-2">‚Üê</span> VOLTAR AO DASHBOARD
                    </button>
                    <div id="logList" class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-20"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modalPag"
        class="hidden fixed inset-0 bg-black/95 flex items-center justify-center p-4 z-[100] backdrop-blur-sm">
        <div class="bg-slate-900 p-8 rounded-3xl w-full max-w-sm border border-slate-800 text-center">
            <h2 id="pagNome" class="text-xl font-black mb-1 text-white uppercase italic">Baixa de Pagamento</h2>
            <div id="pagInfoParcela" class="bg-blue-500/10 text-blue-400 p-3 rounded-xl mb-4 font-bold text-sm"></div>
            <p id="pagRestante" class="text-[10px] text-red-500 mb-6 font-bold uppercase"></p>

            <div class="relative mb-6">
                <span class="absolute left-4 top-4 text-slate-600 font-bold">R$</span>
                <input id="vPago" type="text" oninput="formatarInputMoeda(this)" placeholder="0,00"
                    class="w-full p-4 pl-12 bg-slate-800 rounded-2xl outline-none text-3xl font-black text-emerald-400 border border-slate-700 focus:border-emerald-500 text-center">
            </div>

            <div class="grid grid-cols-1 gap-2 mb-6">
                <button id="btnQuitarTudo" onclick="preencherValorTotal()"
                    class="text-[9px] bg-slate-800 hover:bg-slate-700 p-2 rounded-lg font-bold uppercase text-slate-400 tracking-widest">Quitar
                    Valor Total</button>
            </div>

            <div class="flex gap-3">
                <button id="btnSairModalPag" onclick="fecharModalPag()"
                    class="flex-1 text-slate-500 font-bold uppercase text-[10px]">Sair</button>
                <button id="btnConfirmar" onclick="confirmarPagamento()"
                    class="flex-[2] bg-emerald-600 p-4 rounded-2xl font-black uppercase text-sm text-white shadow-lg shadow-emerald-900/20">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="modalComprovante"
        class="hidden fixed inset-0 bg-black/95 flex items-start justify-center p-2 z-[300] backdrop-blur-md overflow-y-auto">
        <div class="bg-white text-slate-900 p-8 rounded-xl w-full max-w-2xl shadow-2xl my-4">
            <div class="text-center border-b-4 border-blue-600 pb-6 mb-6">
                <h2 class="text-3xl font-black uppercase italic text-blue-600 tracking-tighter">Comprovante</h2>
                <p class="text-xs text-slate-400 font-bold uppercase mt-1">MKS Tech Solutions</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm mb-8">
                <div>
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Nome</p>
                    <p id="compNome" class="font-black text-lg">---</p>
                    <p class="text-[10px] text-slate-400 font-bold uppercase mt-3">Item</p>
                    <p id="compItem" class="font-bold">---</p>
                </div>
                <div>
                    <p class="text-[10px] text-emerald-600 font-bold uppercase">Recebido</p>
                    <p id="compRecebido" class="font-black text-emerald-600 text-lg">---</p>
                    <p class="text-[10px] text-red-600 font-bold uppercase mt-3">Saldo Devedor</p>
                    <p id="compRestante" class="font-black text-red-600 text-lg">---</p>
                </div>
            </div>
            <div class="mt-4">
                <h3 class="text-xs font-black uppercase mb-3 border-l-4 border-blue-600 pl-2">Hist√≥rico</h3>
                <div id="compListaLogs"
                    class="text-xs space-y-2 bg-slate-50 p-4 rounded-xl border italic text-slate-700"></div>
            </div>
            <div class="mt-8 flex gap-3 no-print">
                <button onclick="fecharComprovante()"
                    class="flex-1 bg-slate-200 p-4 rounded-xl font-bold text-xs uppercase">Fechar</button>
                <button onclick="window.print()"
                    class="flex-1 bg-blue-600 text-white p-4 rounded-xl font-black text-xs uppercase">Imprimir</button>
            </div>
        </div>
    </div>

    <div id="modalNovo"
        class="hidden fixed inset-0 bg-black/95 flex items-center justify-center p-4 z-[100] backdrop-blur-sm overflow-y-auto">
        <div class="bg-slate-900 p-6 md:p-8 rounded-3xl w-full max-w-xl border border-slate-800">
            <h2 class="text-xl font-black mb-6 text-blue-500 uppercase italic">Novo Cadastro</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input id="n_nome" placeholder="Nome Completo"
                    class="md:col-span-2 w-full p-4 bg-slate-800 rounded-2xl outline-none border border-slate-700 text-sm font-bold text-white">
                <input id="n_tel" type="tel" placeholder="WhatsApp"
                    class="p-4 bg-slate-800 rounded-2xl outline-none border border-slate-700 text-sm text-white">
                <input id="n_item" placeholder="Modelo do Celular"
                    class="p-4 bg-slate-800 rounded-2xl outline-none border border-slate-700 text-sm text-white">
                <input id="n_valor" type="text" oninput="formatarInputMoeda(this)" placeholder="Valor Total"
                    class="p-4 bg-slate-800 rounded-2xl outline-none border border-slate-700 text-sm font-bold text-white">
                <input id="n_entrada" type="text" oninput="formatarInputMoeda(this)" placeholder="Entrada"
                    class="p-4 bg-slate-800 rounded-2xl outline-none border border-slate-700 text-sm font-bold text-emerald-400">
                <input id="n_val_parc" type="text" oninput="formatarInputMoeda(this)" placeholder="Valor Parcela"
                    class="p-4 bg-slate-800 rounded-2xl outline-none border border-slate-700 text-sm font-bold text-blue-400">
                <select id="n_parc"
                    class="p-4 bg-slate-800 rounded-2xl outline-none border border-slate-700 text-sm font-bold text-slate-300"></select>
                <span class="flex flex-col">
                    <label for="n_data_pag" class="text-slate-400 text-xs font-bold uppercase mb-1 block">Data do 1¬∫
                        Vencimento</label>
                    <input id="n_data_pag" type="date"
                        class="p-4 bg-slate-800 rounded-2xl outline-none border border-slate-700 text-sm text-slate-300">
                </span>
                <textarea id="n_obs" placeholder="Observa√ß√µes..."
                    class="md:col-span-2 w-full p-4 bg-slate-800 rounded-2xl h-20 outline-none border border-slate-700 text-sm text-white"></textarea>
            </div>
            <div class="flex justify-end gap-4 mt-8">
                <button id="btnCancelaNovo" onclick="fecharNovo()"
                    class="text-slate-500 font-bold text-xs uppercase">Cancelar</button>
                <button id="btnSalvar" onclick="salvarNovoCliente()"
                    class="bg-blue-600 px-8 py-4 rounded-2xl font-black uppercase text-xs text-white">Cadastrar</button>
            </div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyfBeTDEkRtbimQkInyyY1pdzumHreDW4BtllDMELUX4JmBUOhcUvJNZREv6TXmR2C2/exec";
        let SENHA_USUARIO = "";
        let DADOS_BRUTOS = [];
        let indexPlanilhaGlobal = -1;
        let saldoDevedorGlobal = "0,00";
        let meuGraficoMensal = null;
        let bloqueado = false;

        const sel = document.getElementById('n_parc');
        if (sel) for (let i = 1; i <= 36; i++) sel.innerHTML += `<option value="${i}">${i}x</option>`;

        function showToast(msg, error = false) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.style.backgroundColor = error ? '#ef4444' : '#059669';
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function formatarInputMoeda(i) {
            let v = i.value.replace(/\D/g, '');
            if (v === "") { i.value = ""; return; }
            v = (parseFloat(v) / 100).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            i.value = v;
        }

        function limparValorParaEnvio(texto) {
            if (!texto) return 0;
            let str = texto.toString().replace("R$", "").replace(/\s/g, "").trim();
            let limpo = str.replace(/\./g, '').replace(',', '.');
            return parseFloat(limpo) || 0;
        }

        function travarInterface(status) {
            bloqueado = status;
            const bts = ['btnSair', 'btnReload', 'btnHist', 'btnNovo', 'btnConfirmar', 'btnSairModalPag', 'btnSalvar', 'btnCancelaNovo', 'btnQuitarTudo'];
            bts.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.disabled = status;
                    if (status) el.classList.add('loading-state');
                    else el.classList.remove('loading-state');
                }
            });
        }

        async function fazerLogin() {
            const btn = document.getElementById('btnLogin');
            const senhaInput = document.getElementById('input-senha').value;
            if (!senhaInput) return;
            btn.innerHTML = `<span>VALIDANDO...</span><span class="animate-spin text-lg">‚è≥</span>`;
            btn.disabled = true;
            SENHA_USUARIO = senhaInput;
            const sucesso = await carregar();
            if (sucesso) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
            } else { alert("Senha incorreta"); SENHA_USUARIO = ""; }
            btn.innerHTML = `<span>ENTRAR</span><span class="text-lg">‚Üí</span>`;
            btn.disabled = false;
        }

        async function carregar() {
            travarInterface(true);
            const btnReload = document.getElementById('btnReload');
            if (btnReload) btnReload.innerText = "‚åõ";

            try {
                const res = await api({ action: "buscar" });
                if (!res || !res.rows) return false;

                DADOS_BRUTOS = res.rows;
                document.getElementById('st-bruto').innerText = `R$ ${res.stats.bruto.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                document.getElementById('st-rec').innerText = `R$ ${res.stats.recebido.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                document.getElementById('st-rest').innerText = `R$ ${res.stats.restante.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;

                renderGraficoMensal(DADOS_BRUTOS);
                renderTabela(DADOS_BRUTOS);
                renderLogs(DADOS_BRUTOS);
                return true;
            } catch (e) { return false; }
            finally {
                if (btnReload) btnReload.innerText = "üîÑ";
                travarInterface(false);
            }
        }

        function renderTabela(rows) {
            const busca = document.getElementById('busca').value.toLowerCase();
            const lista = document.getElementById('lista');
            const hoje = new Date().setHours(0, 0, 0, 0);

            let filtrados = rows.filter(r => {
                const saldo = limparValorParaEnvio(r[6]);
                if (busca === "") return r[12] !== "Conclu√≠do" && saldo > 0;
                return r[0].toLowerCase().includes(busca);
            });

            filtrados.sort((a, b) => converterData(a[7]) - converterData(b[7]));

            lista.innerHTML = filtrados.map((row) => {
                const idxReal = row[row.length - 1];
                const dataVenc = converterData(row[7]);
                const diffDias = Math.floor((dataVenc - hoje) / (1000 * 60 * 60 * 24));
                let corData = "text-blue-400"; let statusIcon = ""; let rowClass = "";

                if (row[12] !== "Conclu√≠do") {
                    if (diffDias < 0) { corData = "text-red-500"; statusIcon = "‚ö†Ô∏è "; rowClass = "atrasado-row"; }
                    else if (diffDias <= 3) { corData = "text-orange-500"; statusIcon = "üïí "; }
                }

                return `<tr class="${rowClass} border-b border-slate-800/50 hover:bg-slate-900/40">
                    <td class="p-5 font-bold text-sm">${row[0]}</td>
                    <td class="p-5 text-xs text-slate-500">${row[2]}</td>
                    <td class="p-5 text-xs font-bold text-red-400">${row[6]}</td>
                    <td class="p-5 text-xs font-black ${corData}">${statusIcon}${row[7]}</td>
                    <td class="p-5 text-center"><button onclick="abrirPag(${idxReal})" class="bg-blue-600 px-5 py-2 rounded-xl text-[10px] font-black uppercase text-white hover:bg-blue-500">Receber</button></td>
                </tr>`;
            }).join('');
        }

        function renderLogs(rows) {
            const busca = document.getElementById('busca').value.toLowerCase();
            const container = document.getElementById('logList');
            const clientesComLogs = rows.filter(r => (r[17] && r[17].toString().trim() !== "") || r[12] === "Conclu√≠do");

            container.innerHTML = clientesComLogs.reverse().map(r => {
                const saldoNum = limparValorParaEnvio(r[6]);
                const isConcluido = r[12] === "Conclu√≠do" || saldoNum <= 0;

                const logRaw = r[17] || "";
                const itensLog = logRaw.split('|').map(p => p.trim()).filter(p => p.length > 0).reverse();
                if (busca !== "" && !r[0].toLowerCase().includes(busca)) return "";

                return `<div class="bg-slate-900 p-5 rounded-3xl border border-slate-800 border-l-4 ${isConcluido ? 'border-l-emerald-500 shadow-lg shadow-emerald-950/20' : 'border-l-blue-600'}">
                    <div class="flex justify-between items-start mb-4">
                        <div class="truncate"><h4 class="text-white font-black uppercase text-xs italic">${r[0]}</h4><p class="text-[9px] text-slate-500 font-bold uppercase">${r[2]}</p></div>
                        <div class="flex items-center gap-2">
                            ${isConcluido ? '<span class="text-[8px] bg-emerald-500/10 text-emerald-500 px-2 py-1 rounded-lg font-black tracking-widest animate-pulse">QUITADO</span>' : ''}
                            <button onclick="gerarComprovante(${r[r.length - 1]})" class="text-[9px] bg-slate-800 px-3 py-1 rounded-full font-bold hover:bg-slate-700 transition-colors">üìÑ Recibo</button>
                        </div>
                    </div>
                    <div class="text-[11px] text-slate-400 font-mono bg-slate-950 p-4 rounded-2xl border border-slate-800/50 space-y-2 max-h-40 overflow-y-auto">
                        ${itensLog.length > 0 ? itensLog.map((p, i) => `<div class="${i === 0 ? 'text-emerald-400 font-bold' : ''} py-1 border-b border-slate-800 last:border-0">${p}</div>`).join('') : '<div class="text-slate-600 italic">Sem registros</div>'}
                    </div>
                </div>`;
            }).join('');
        }

        function renderGraficoMensal(rows) {
            const ctx = document.getElementById('graficoMensal');
            if (!ctx) return;
            const ultimos6Meses = [];
            const nomesMeses = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
            const hoje = new Date();

            for (let i = 5; i >= 0; i--) {
                const d = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                ultimos6Meses.push({ mes: d.getMonth(), ano: d.getFullYear(), label: `${nomesMeses[d.getMonth()]}/${d.getFullYear().toString().slice(-2)}`, total: 0 });
            }

            rows.forEach(row => {
                const log = row[17] || "";
                log.split('|').forEach(p => {
                    const matchVal = p.match(/R\$\s?([\d,.]+)/);
                    const matchData = p.match(/(\d{2})\/(\d{2})\/(\d{2,4})/);
                    if (matchVal && matchData) {
                        const v = parseFloat(matchVal[1].replace(/\./g, '').replace(',', '.'));
                        const mesLog = parseInt(matchData[2]) - 1;
                        let anoLog = parseInt(matchData[3]);
                        if (anoLog < 100) anoLog += 2000;
                        ultimos6Meses.forEach(m => { if (m.mes === mesLog && m.ano === anoLog) m.total += v; });
                    }
                });
            });

            if (meuGraficoMensal) meuGraficoMensal.destroy();
            meuGraficoMensal = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: { labels: ultimos6Meses.map(m => m.label), datasets: [{ data: ultimos6Meses.map(m => m.total), backgroundColor: '#3b82f6', borderRadius: 8 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#1e293b' }, ticks: { color: '#94a3b8', font: { size: 10 } } }, x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 10 } } } } }
            });
        }

        function abrirPag(idx) {
            if (bloqueado) return;
            indexPlanilhaGlobal = idx;
            const item = DADOS_BRUTOS.find(r => r[r.length - 1] === idx);
            document.getElementById('pagNome').innerText = item[0];
            document.getElementById('pagInfoParcela').innerText = `VALOR DA PARCELA: ${item[8]}`;
            document.getElementById('pagRestante').innerText = `SALDO TOTAL: ${item[6]}`;
            saldoDevedorGlobal = item[6].toString().replace("R$", "").replace(/\s/g, "").trim();
            document.getElementById('vPago').value = item[8].toString().replace("R$", "").replace(/\s/g, "").trim();
            document.getElementById('modalPag').classList.remove('hidden');
        }

        function preencherValorTotal() {
            if (bloqueado) return;
            document.getElementById('vPago').value = saldoDevedorGlobal;
        }

        async function confirmarPagamento() {
            const btn = document.getElementById('btnConfirmar');
            const valorInput = document.getElementById('vPago').value;
            if (!valorInput || bloqueado) return;
            if (!confirm(`Deseja confirmar o recebimento de R$ ${valorInput}?`)) return;

            const valorParaAPI = limparValorParaEnvio(valorInput);
            document.getElementById('modalPag').classList.add('hidden');
            travarInterface(true);

            try {
                await api({ action: "pagar", indexPlanilha: indexPlanilhaGlobal, valorPago: valorParaAPI });
                showToast("Pagamento registrado!");
                await carregar();
            } catch (e) {
                showToast("Erro ao processar", true);
                await carregar();
            } finally {
                travarInterface(false);
            }
        }

        async function api(dados) {
            dados.senha = SENHA_USUARIO;
            const res = await fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify(dados) });
            return await res.json();
        }

        function converterData(str) {
            if (!str) return new Date();
            const p = str.split('/');
            return new Date(p[2], p[1] - 1, p[0]);
        }

        function switchTab(t) {
            if (bloqueado) return;
            document.getElementById('tab-dash').classList.toggle('hidden', t !== 'dash');
            document.getElementById('tab-logs').classList.toggle('hidden', t !== 'logs');
        }

        function filtrarTudo() { renderTabela(DADOS_BRUTOS); renderLogs(DADOS_BRUTOS); }
        function fecharModalPag() { if (!bloqueado) document.getElementById('modalPag').classList.add('hidden'); }
        function fecharNovo() { if (!bloqueado) document.getElementById('modalNovo').classList.add('hidden'); }
        function abrirNovo() { if (!bloqueado) { document.getElementById('n_data_pag').valueAsDate = new Date(); document.getElementById('modalNovo').classList.remove('hidden'); } }

        async function salvarNovoCliente() {
            if (bloqueado) return;
            if (!document.getElementById('n_nome').value || !document.getElementById('n_valor').value) return alert("Preencha Nome e Valor.");
            if (!confirm("Confirmar cadastro do novo cliente?")) return;

            document.getElementById('modalNovo').classList.add('hidden');
            travarInterface(true);

            try {
                await api({
                    action: "adicionar", nome: document.getElementById('n_nome').value, tel: document.getElementById('n_tel').value,
                    item: document.getElementById('n_item').value, valor: limparValorParaEnvio(document.getElementById('n_valor').value),
                    entrada: limparValorParaEnvio(document.getElementById('n_entrada').value) || 0,
                    valorParcela: limparValorParaEnvio(document.getElementById('n_val_parc').value) || 0,
                    parcelas: document.getElementById('n_parc').value, dataPrimeiroPag: document.getElementById('n_data_pag').value,
                    obs: document.getElementById('n_obs').value
                });
                showToast("Cliente Cadastrado!");
                await carregar();
            } catch (e) {
                showToast("Erro ao cadastrar", true);
                await carregar();
            } finally {
                travarInterface(false);
            }
        }

        function gerarComprovante(idx) {
            if (bloqueado) return;
            const d = DADOS_BRUTOS.find(r => r[r.length - 1] === idx);
            document.getElementById('compNome').innerText = d[0];
            document.getElementById('compItem').innerText = d[2];
            document.getElementById('compRecebido').innerText = d[5];
            document.getElementById('compRestante').innerText = d[6];
            const logRaw = d[17] || "";
            document.getElementById('compListaLogs').innerHTML = logRaw.split('|').reverse().map(l => l.trim() ? `<div class="border-b border-slate-100 py-1 last:border-0">${l.trim()}</div>` : '').join('');
            document.getElementById('modalComprovante').classList.remove('hidden');
        }

        function fecharComprovante() { document.getElementById('modalComprovante').classList.add('hidden'); }
        function fazerLogout() {
            if (bloqueado) return;

            // Limpa a vari√°vel global de senha
            SENHA_USUARIO = "";

            // Limpa visualmente o campo de input de senha
            const campoSenha = document.getElementById('input-senha');
            if (campoSenha) {
                campoSenha.value = "";
            }

            // Alterna as telas
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }
    </script>
</body>

</html>
